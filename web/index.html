<html>
	<head>
		<script>
			function clearOutput() {
				document.getElementById("output").innerHTML = "";
			}

			function runProgram() {
				clearOutput();

				const memory = new WebAssembly.Memory({ initial: 1 });

				const wasmImports = {
					imports: {
						imported_func: (arg) => {
							document.getElementById("output").innerHTML += `<p>${arg}</p>`;
						},
						print: (location => {
							const append = (content) => {
								document.getElementById("output").innerHTML += `<p>${content}</p>`
							}

							const dataview = (new DataView(memory.buffer))
							// They give us location = stack pointer
							const type = dataview.getInt32(location, true);
							switch (type) {
								case 0:
									append("nil");
									break;
								case 1:
									append(dataview.getInt32(location + 4, true));
									break;

								case 3:
									const val = dataview.getInt32(location + 4, true);
									append(val === 0 ? "false" : "true");
									break;

								case 4:
									const stringLocation = dataview.getInt32(location + 4, true);
									const size = dataview.getInt32(stringLocation, true);
									const bytes = new Uint8Array(memory.buffer, stringLocation + 4, size);
									const string = new TextDecoder("utf8").decode(bytes);
									append(string);
									break;
							}
						})
					},
					js: {mem: memory}
				}

				WebAssembly.instantiateStreaming(fetch("./compiled.wasm"), wasmImports).then(
					(obj) => obj.instance.exports.main()
				);
			}
		</script>
	</head>
	<body>
		<h1>Lua WebAssembly</h1>
		<p>
			<button onclick="runProgram()">Run Program</button>
		</p>
		<p>
			<button onclick="clearOutput()">Clear Output</button>
		</p>

		<p>Output:</p>
		<div id="output">
		</div>
	</body>
</html>
